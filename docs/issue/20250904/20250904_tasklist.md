# 20250904 Webスクレイピング改修 タスクリスト

## 1. 要件サマリ
- 追加取得対象: 「地金型コイン相場」テーブル内の以下商品小売価格（税込）
  - メイプルリーフ金貨・ウィーン金貨ハーモニー 1オンス / 1/2オンス / 1/4オンス / 1/10オンス
- 既存取得: 「地金相場」内の金 小売価格（税込）
- 出力CSV新仕様（1商品1行, 追記, ヘッダ無し）
  - ファイル名: `ishihuku-price-yyyymmdd.csv` （※現行: `ishihuku-gold-yyyymmdd.csv` から変更）
  - 列順: 当日日付(YYYY-MM-DD), 商品名, 小売価格(数値), データ取得日時(YYYY-MM-DD HH:MM:SS)
  - 商品名バリエーション（確定ラベル）:
    - 金
    - メイプルリーフ金貨・ウィーン金貨ハーモニー(1oz)
    - メイプルリーフ金貨・ウィーン金貨ハーモニー(1/2oz)
    - メイプルリーフ金貨・ウィーン金貨ハーモニー(1/4oz)
    - メイプルリーフ金貨・ウィーン金貨ハーモニー(1/10oz)
- エラーハンドリング: 個別項目取得失敗時はログ出力し他項目処理継続。全滅時のみ失敗扱い。
- 既存コード再利用方針: HTML取得～テーブル解析（BeautifulSoup）/ ログ / 日付ユーティリティ / Selenium管理を流用。

## 2. 現行実装概要と課題
| 領域 | 現状 | 課題/変更点 |
|------|------|-------------|
| 抽出 | `GoldPriceExtractor` が単一の金価格(int)のみ返却 | 複数商品抽出ロジックが無い。拡張設計が必要。
| パース | `HTMLParser.extract_table_data()` は全テーブル2次元配列を返す | 商品名→価格のマッピング層を新設可能。
| 保存 | `CSVStorage.save()` は (date, gold_price, datetime) の3列固定 | 新フォーマット4列 & 商品名を受け取る汎用化が必要。旧互換を壊さない設計。
| ファイル名 | `StorageConfig.csv_filename_template` = `ishihuku-gold-{date}.csv` | 新テンプレ追加 or 切替。互換維持のためプロパティ分離が望ましい。
| コア | `GoldPriceScraper.scrape_and_save()` が単一価格取得→保存 | 複数商品ループ処理＋部分失敗集計が必要。
| テスト | 単一価格抽出テストのみ | 複数商品/CSV行検証テスト追加。

## 3. 変更設計（案）
### 3.1 データモデル
```python
@dataclass
class ProductPrice:
    product_name: str  # 上記ラベル
    price: int | None  # 取得失敗時 None
```
結果コンテナ: `List[ProductPrice]`。

### 3.2 抽出ロジック拡張
アプローチ: 既存 `HTMLParser.extract_table_data()` の出力を走査し以下マッチング:
- 金価格行判定: 既存の `GoldPriceExtractor._is_gold_row`
- コイン行判定: `th`/`td` のテキストに以下パターン
  - 'メイプルリーフ金貨' or 'ウィーン金貨ハーモニー' を含みサイズ表記 ('1オンス','1/2','1/4','1/10')
- 対応する小売価格セル: 行の2番目または3番目セル（既存ロジック準拠）
- 抽出関数新設例: `extract_multiple_prices(html: str) -> List[ProductPrice]`
  - 金1件 + コイン4サイズ×1種の計5行（要件ラベルまとめ）
  - 将来別コイン追加を見据え拡張可能な mapping dict を内部保有

### 3.3 ラベリング
サイズ正規化マップ:
```
{
 '1オンス': '(1oz)',
 '1/2オンス': '(1/2oz)',
 '1/4オンス': '(1/4oz)',
 '1/10オンス': '(1/10oz)'
}
```
ベース名称: 'メイプルリーフ金貨・ウィーン金貨ハーモニー' + 正規化サイズ。

### 3.4 CSV保存仕様
新メソッド `CSVStorage.save_product_row(data: Dict)` or 汎用 `save()` の引数拡張:
```
{
  'date_str': 'YYYY-MM-DD',
  'product_name': str,
  'price': int,
  'datetime_str': 'YYYY-MM-DD HH:MM:SS',
  'date_for_filename': 'YYYYMMDD'
}
```
ファイル名: 新テンプレ `ishihuku-price-{date}.csv` を `StorageConfig` に追加（旧フィールドは現状維持）。
後方互換: 既存 `save()` をそのまま使用する呼び出しは影響避ける（分岐）。

### 3.5 コア処理改修
- 新クラス `ProductPriceScraper` 追加 or 既存 `GoldPriceScraper` を汎用化。
- 低リスク: 既存を拡張し `scrape_all_and_save()` 新設。
処理流れ:
1. 既存ナビゲーションで価格ページへ
2. HTML取得
3. 複数商品抽出
4. 少なくとも1価格成功→CSVに行ごと追記
5. 全失敗→空ファイル生成 + エラー

### 3.6 ロギング
- 取得成功/失敗を商品単位で info/warning ログ
- 集計サマリ: 取得成功件数, 失敗件数

### 3.7 エラーハンドリング
- 個別行抽出失敗は例外にしない。`price=None` として保持し保存対象外（要件: 他継続）
- 保存前に `price is not None` の行のみ出力
- 全行失敗時のみ例外送出

### 3.8 テスト追加
- HTMLフィクスチャ（テーブル）から5行抽出成功
- 一部欠損（サイズ行欠落）で他行は成功
- 全欠損で例外 or 空リスト判定
- CSV出力行数検証（ヘッダ無 / 追記動作）

### 3.9 移行方針
- 旧単一取得 `scrape_and_save` は現状維持（互換）
- 新機能利用は将来エントリポイントで切替（この段階では未改修可）

## 4. 実装タスク詳細 (WBS)
1. 設定拡張
   - [x] `StorageConfig` に `csv_filename_price_template = "ishihuku-price-{date}.csv"` 追加
2. データモデル
   - [x] `models.py` (新規) に `ProductPrice` dataclass 追加
3. 抽出ロジック
   - [x] `extractor.py` に複数商品用クラス `MultiProductPriceExtractor` 追加
   - [x] 既存 `GoldPriceExtractor` のユーティリティ関数再利用 (price parse / validation)
   - [x] パターンマッピング/正規化実装
4. コア拡張
   - [x] `GoldPriceScraper` に `scrape_all_product_prices()` 追加（HTML→List[ProductPrice]）
   - [x] `scrape_all_and_save()` 実装（ループ保存）
5. CSV拡張
   - [x] `CSVStorage` に新メソッド `save_product_row()` または `save()` 内で dictキーで分岐（`multi_product` フラグで分岐実装済）
   - [x] バッチ保存 `save_products(products)` 実装（成功価格のみ）
6. 例外/ログ
   - [x] 商品ごとの成功/失敗ログ
   - [x] 全失敗時の例外設計
7. テスト
   - [x] 新規 `tests/test_multi_products.py` 追加
   - [x] 正常系: 5件取得
   - [x] 部分欠損
   - [x] 全欠損（全失敗ケースは extractor の例外検証は今後拡張余地）
   - [x] CSV行数/内容検証 (tempfile利用)
8. ドキュメント
   - [x] `README.md` に新CSV仕様追記（既存goldファイルとの差）
   - [x] `ARCHITECTURE_v2.md` にデータフロー差分追記
   - [x] このタスクリストに進捗チェック欄更新
9. リファクタ/整合性
   - [x] mypy/flake8/black/isort パス確認 & 修正

## 5. リスクと備考
- HTML構造変更: XPathハードコードを避けテキストマッチ中心
- 価格セル位置揺れ: 2列目→失敗→3列目フォールバック継続
- 国際化/文字揺れ: 全角/半角スペース除去・正規化を行う
- 将来追加: プラチナ等を追加する際は拡張 extractor 内マッピングで対応

## 6. 完了条件
- 指定5商品（うち金1＋コイン4サイズ）が正常環境で取得され、`ishihuku-price-YYYYMMDD.csv` にヘッダなしで追記される
- 全スタイル / 静的解析 / テストパス
- 既存単一金価格機能が回帰しない（既存テストグリーン）

