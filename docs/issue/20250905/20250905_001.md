### **作業指示書：`main_lambda.py` の複数商品価格取得対応**

#### 1. 目的

`main_lambda.py` を修正し、AWS Lambda 環境で実行された際に、石福金属興業のウェブサイトから**金**および**地金型コイン（メイプルリーフ金貨・ウィーン金貨ハーモニー）**の価格を両方取得できるようにする。

この変更は、コマンドライン引数（`--multi`）を使用せず、常に複数商品を取得する仕様とする。

#### 2. 背景

  - 現在の `main_lambda.py` は、金価格のみを取得する `scraper.scrape_and_save()` メソッドを呼び出している。
  - `core.py` には、金とコインの両価格を取得する `scraper.scrape_all_and_save()` メソッドが既に実装されている。
  - この既存の機能を `main_lambda.py` から呼び出し、戻り値の形式をLambdaのレスポンスとして適切に処理するように修正する必要がある。

#### 3. 作業対象ファイル

  - `main_lambda.py`

#### 4. 具体的な作業手順

##### ステップ1: スクレイピング処理の呼び出しメソッド変更

`main_lambda.py` の `lambda_handler` 関数内で行われているスクレイピング処理の呼び出しを、単一商品用から複数商品用に変更します。

  - **修正箇所:** `lambda_handler` 関数内の `scraper.scrape_and_save()`
  - **変更内容:**
      - `result = scraper.scrape_and_save()`
      - 上記の行を下記に置き換えます。
      - `result = scraper.scrape_all_and_save()`

##### ステップ2: 成功時のレスポンス（`body`）の修正

`scrape_all_and_save()` メソッドの戻り値には、単一の `gold_price` ではなく、`ProductPrice` オブジェクトのリストが `products` というキーで格納されています。これに合わせて、Lambdaの成功レスポンスを修正します。

  - **修正箇所:** `lambda_handler` 関数内の `return` ステートメント（`statusCode: 200` のブロック）
  - **変更内容:**
    1.  `result` ディクショナリから `products` リストを取得します。
    2.  `ProductPrice` オブジェクトは直接JSONに変換できないため、辞書のリストに変換します。
    3.  レスポンス `body` 内の `"gold_price": result.get("gold_price")` を削除し、代わりに変換した商品リスト `"products": ...` を含めます。

##### ステップ3: ログ出力の調整 (推奨)

処理結果が分かりやすくなるように、成功時のログメッセージを修正します。

  - **修正箇所:** `lambda_handler` 関数内の `logger.info("✅ Lambda スクレイピング処理が正常に完了しました")`
  - **変更内容:** 取得できた商品数などをログに出力するように変更します。

#### 5. 修正コード（変更前後の比較）

以下に `main_lambda.py` の `lambda_handler` 関数の修正前と修正後のコードを示します。この通りに修正してください。

-----

**【変更前】** `main_lambda.py`

```python
def lambda_handler(event: Dict[str, Any], context: Any) -> Dict[str, Any]:
    """
    Lambda関数のエントリーポイント

    Args:
        event: Lambda イベント
        context: Lambda コンテキスト

    Returns:
        dict: 実行結果
    """
    # Lambda環境用のロガー設定
    logger = setup_lambda_logging()

    try:
        logger.info("Lambda Selenium スクレイピング処理を開始")

        # 設定を取得
        config = get_config("lambda")

        # ストレージを S3 に設定
        if not is_s3_available():
            raise RuntimeError(
                "S3 が利用できません。boto3 をインストールしてください。"
            )

        storage = create_s3_storage(config=config.storage)

        # スクレイパーを作成
        scraper = GoldPriceScraper(config=config, storage=storage)

        # スクレイピングを実行
        result = scraper.scrape_and_save() # <--【変更点①】

        if result.get("success"):
            logger.info("✅ Lambda スクレイピング処理が正常に完了しました") # <--【変更点③】

            # 結果を返す
            return { # <--【変更点②】
                "statusCode": 200,
                "body": json.dumps(
                    {
                        "success": True,
                        "message": "スクレイピングが正常に完了しました",
                        "data": result,
                        "timestamp": result.get("datetime_str"),
                        "gold_price": result.get("gold_price"),
                    },
                    ensure_ascii=False,
                ),
            }
        else:
            error_msg = result.get("error")
            logger.error(f"❌ スクレイピング処理が失敗しました: {error_msg}")

            return {
                "statusCode": 500,
                "body": json.dumps(
                    {
                        "success": False,
                        "message": f"スクレイピング処理が失敗しました: {error_msg}",
                        "error": error_msg,
                    },
                    ensure_ascii=False,
                ),
            }

    except Exception as e:
        logger.error(f"❌ 予期しないエラーが発生しました: {str(e)}")

        return {
            "statusCode": 500,
            "body": json.dumps(
                {
                    "success": False,
                    "message": "予期しないエラーが発生しました",
                    "error": str(e),
                },
                ensure_ascii=False,
            ),
        }
```

-----

**【変更後】** `main_lambda.py`

```python
def lambda_handler(event: Dict[str, Any], context: Any) -> Dict[str, Any]:
    """
    Lambda関数のエントリーポイント

    Args:
        event: Lambda イベント
        context: Lambda コンテキスト

    Returns:
        dict: 実行結果
    """
    # Lambda環境用のロガー設定
    logger = setup_lambda_logging()

    try:
        logger.info("Lambda Selenium スクレイピング処理を開始")

        # 設定を取得
        config = get_config("lambda")

        # ストレージを S3 に設定
        if not is_s3_available():
            raise RuntimeError(
                "S3 が利用できません。boto3 をインストールしてください。"
            )

        storage = create_s3_storage(config=config.storage)

        # スクレイパーを作成
        scraper = GoldPriceScraper(config=config, storage=storage)

        # スクレイピングを実行 (複数商品取得に変更)
        result = scraper.scrape_all_and_save() # <--【修正後①】

        if result.get("success"):
            products = result.get("products", [])
            # ProductPriceオブジェクトを辞書のリストに変換
            product_list = [p.__dict__ for p in products]
            success_count = sum(1 for p in product_list if p.get("price") is not None)

            # ログを調整
            logger.info(f"✅ Lambda スクレイピング処理が正常に完了しました (取得商品数: {success_count}/{len(product_list)})") # <--【修正後③】

            # 結果を返す (レスポンス形式を修正)
            return { # <--【修正後②】
                "statusCode": 200,
                "body": json.dumps(
                    {
                        "success": True,
                        "message": "スクレイピングが正常に完了しました",
                        "filepath": result.get("filepath"),
                        "timestamp": result.get("datetime_str"),
                        "products": product_list, # 取得した商品リストを返す
                    },
                    ensure_ascii=False,
                ),
            }
        else:
            error_msg = result.get("error")
            logger.error(f"❌ スクレイピング処理が失敗しました: {error_msg}")

            return {
                "statusCode": 500,
                "body": json.dumps(
                    {
                        "success": False,
                        "message": f"スクレイピング処理が失敗しました: {error_msg}",
                        "error": error_msg,
                    },
                    ensure_ascii=False,
                ),
            }

    except Exception as e:
        logger.error(f"❌ 予期しないエラーが発生しました: {str(e)}")

        return {
            "statusCode": 500,
            "body": json.dumps(
                {
                    "success": False,
                    "message": "予期しないエラーが発生しました",
                    "error": str(e),
                },
                ensure_ascii=False,
            ),
        }
```

-----

#### 6. 確認事項

作業完了後、tests/test_main_lambda.pyをテスト実行し、以下の点を確認してください。

  - 実行がエラーなく完了すること。
  - 実行ログに「✅ Lambda スクレイピング処理が正常に完了しました (取得商品数: X/Y)」のようなメッセージが出力されること。
  - Lambda の実行結果（レスポンスボディ）に、`products` キーが含まれ、その値が以下のようなリスト形式になっていること。
    ```json
    "products": [
        {"product_name": "金", "price": 13000},
        {"product_name": "メイプルリーフ金貨・ウィーン金貨ハーモニー(1oz)", "price": 400000},
        {"product_name": "メイプルリーフ金貨・ウィーン金貨ハーモニー(1/2oz)", "price": 200000},
        ...
    ]
    ```
  - 取得に失敗した商品がある場合、`price` の値が `null` または `None` となっていること。

以上で作業は完了です。